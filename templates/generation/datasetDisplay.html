{% extends "base.html" %}
{% load static %}


{#context contains: dataset  #}
{% block content_fluid %}
    <div class="row">
        <div class="col-md-9" style="height:100%">

            <div id="data-chart">
                <div id="data-container" style="height: calc(100vh - 70px);"></div>
            </div>
        </div>
        <div class="col-md-3" id="menu">
            {% include "parts/dataset_description.html" %}
        </div>
    </div>
    {% csrf_token %}
    <script>
        const dataset = "{{ dataset }}";
        const renderedSeries = []
        // on document ready send request to obtian data from rendered series

        let dataChart = Highcharts.chart(`data-container`, {
            chart: {
                type: 'line',
                zoomType: 'x'
            },
            plotOptions: {
                series: {
                    pointStart: Date.UTC(2020, 0, 1),
                    pointInterval: 1000 * 10                }
            },
            title: {
                text: ""//this.title
            },
            xAxis: {
                type: 'datetime',
            },
            yAxis: {
                title: {
                    text: 'Value'
                }
            },
            legend: {
                enabled: true,
                verticalAlign: 'top',
            },
            series: renderedSeries,
            navigator: {
                enabled: true, // Set to true to enable the navigator
            },
            rangeSelector: {
                selected: 3,
                enabled: true,
                buttons: [{
                    type: 'millisecond',
                    count: 10000 * 6,
                    text: '1m'
                }, {
                    type: 'millisecond',
                    count: 10000 * 6 * 10,
                    text: '10m'
                }, {
                    type: 'millisecond',
                    count: 10000 * 6 * 60,
                    text: '1h'
                }, {
                    type: 'millisecond',
                    count: 10000 * 6 * 60 * 24,
                    text: '1d'
                },
                    {
                        type: 'millisecond',
                        count: 10000 * 6 * 60 * 24 * 7,
                        text: '1w'
                    },
                    {
                        type: 'all',
                        text: 'All'
                    }],
            },

            scrollbar: {
                liveRedraw: false
            },
        });

        $(document).ready(function () {
            console.log("READY")
            $.ajax({
                url: "{% url 'datasetDisplay' dataset=dataset %}",
                type: "POST",
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                data: {},
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    {#renderedSeries = data;#}
                    data.dataset.forEach((d, i) => {
                        console.log("adding series", d.name)
                        dataChart.addSeries({
                            name: d.name,
                            data: d.data,
                            type: 'line',
                            visible: i < 4,
                            tooltip: {
                                valueDecimals: 2
                            }
                        })
                    })
                }
            });
        });

    </script>
{% endblock %}
