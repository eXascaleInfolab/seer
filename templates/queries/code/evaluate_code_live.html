<script>

    const evaluateBTN = document.getElementById("evaluateBTN")

    evaluateBTN.addEventListener("click", evaluate)

    function evaluate() {
        if (!QueryHandler.checkFrameValues()) {
            return false
        }

        let query_frequencies = document.getElementsByClassName('frequency-input');
        let length = query_frequencies.length;
        let frequencies = []
        for (let i = 0; i < length; i++) {
            frequencies.push(query_frequencies[i].value);
        }

        // Fetch all forms with class 'query-box-form'
        const forms = document.querySelectorAll('.query-box-form');

        // Array to hold data of each form
        let formsData = [];

        // Iterate over forms and collect their data

        // Get the CSRF token from the first form
        const csrfTokenInput = forms[0].querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;

        forms.forEach((form, index) => {
            let formData = {};

            // Loop through form elements and collect data
            for (let element of form.elements) {
                if (element.name) {
                    formData[element.name] = element.value;
                }
            }
            // Add this form's data to the array
            formsData.push(formData);
            console.log(`Form ${index + 1} data:`, formData);
        });
        console.log(JSON.stringify(formsData))


        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formsData)
        })
            .then(response => response.json())
            .then(data => {
                //        #runtime, query, numberOfQueries, query_results

                displayOnlineResults(data.runtime, data.query, data.numberOfQueries, data.query_results)
                console.log(data.offline_query_results)
                updateChart(data.offline_query_results.data , data.runtime , data.system)
                console.log("boxplot data: " , data.boxplot_data)
                addBoxPlot(data.label, data.boxplot_data)
            })
            .catch((error) => console.error('Error:', error));
    }

    function formatMilliseconds(milliseconds) {
        const seconds = (milliseconds / 1000).toFixed(2);
        return `${seconds} seconds`;
    }

    let Query_results = null
    function displayOnlineResults(runtime, query, numberOfQueries, query_results) {
        // Store the query results in a global variable (debugging)
        Query_results = query_results

        resultContainer = document.getElementById("results-container")
        resultContainer.innerHTML = ""
        // Create a container div for the results
        const container = document.createElement('div');

        // Display runtime
        const runtimeElement = document.createElement('p');
        runtimeElement.textContent = `Runtime: ${runtime} milliseconds`;
        container.appendChild(runtimeElement);

        // Display query
        const queryElement = document.createElement('p');
        queryElement.textContent = `Query: ${query}`;
        container.appendChild(queryElement);

        // Display number of queries
        const numQueriesElement = document.createElement('p');
        numQueriesElement.textContent = `Number of Results: ${numberOfQueries}`;
        container.appendChild(numQueriesElement);

        // Display query results
        const resultsElement = document.createElement('ul');
        resultsElement.style.maxHeight = "200px"
        resultsElement.style.overflowY = "scroll"
        query_results.forEach((result, index) => {
            if (index < 10) {
                const listItem = document.createElement('li');
                listItem.textContent = JSON.stringify(result); //`${result}`
                resultsElement.appendChild(listItem);
            }
            if(index == 10){
                     const listItem = document.createElement('li');
                listItem.textContent = "..."  +  (parseInt(numberOfQueries)-10) + " results not displayed";
                resultsElement.appendChild(listItem );
            }
        });
        container.appendChild(resultsElement);

        // Append the container to the document (you can adjust this part based on your HTML structure)
        resultContainer.appendChild(container)
    }

      let chart;
    let seriesData = [];

    // Function to create or update the Highcharts chart
    function createChart() {
        chart = Highcharts.chart('chart-container', {
            chart: {
                type: 'column'
            },
            title: {
                text: 'Runtime'
            },
            xAxis: {
                categories: systems
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Time (ms)'
                }
            },
            plotOptions: {
                series: {
                    stacking: 'normal'
                }
            },
            series: [{
                name: "placeholder",
                data: [0, 0, 0, 0, 0, 0, 0],
                showInLegend: false
            }]
        });
    }

    // Function to update the chart data
    function updateChart(newData ,new_system_runtime, new_system) {
        if (!chart) {
            createChart(newData);
        } else {
            // Remove all current series
            let n_series = chart.series.length;
            for (let i = 0; i < n_series; i++) {
                chart.series[0].remove();
            }
        }
        console.log(newData)

        // check of has key "online"

        //[query_runtime.influx, query_runtime.questdb, query_runtime.timescaledb, query_runtime.monetdb, query_runtime.extremedb, query_runtime.clickhouse, query_runtime.druid]

            Object.keys(newData).forEach(query => {
                const query_runtime = newData[query]
                let runtime_data =  Object.keys(query_runtime).map(key => query_runtime[key])
                runtime_data.push({ y: new_system_runtime , color : 'red'})

                let categories = Object.keys(query_runtime)
                categories.push(new_system)

                chart.xAxis[0].setCategories(categories);

                console.log("query", query);
                // add series to chart
                chart.addSeries({
                    name: query,
                    data: runtime_data,
                    showInLegend: true
                }, false);
            })

        chart.redraw();

    }
</script>